<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>U.S. Olympian Hometowns</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700&family=Public+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <style>
      :root {
        --bg: #ecf5ff;
        --card: rgba(255, 255, 255, 0.9);
        --ink: #0b2846;
        --muted: #395a7d;
        --accent: #0e4f8a;
        --usa-red: #c62230;
        --usa-blue: #1b4d88;
        --frost: #d7ebff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Public Sans", "Trebuchet MS", sans-serif;
        background: var(--bg);
        color: var(--ink);
        min-height: 100vh;
        background-image:
          radial-gradient(circle at 20% 18%, rgba(255, 255, 255, 0.95) 0 2px, transparent 2px),
          radial-gradient(circle at 72% 32%, rgba(255, 255, 255, 0.9) 0 2px, transparent 2px),
          radial-gradient(circle at 48% 72%, rgba(255, 255, 255, 0.75) 0 1.5px, transparent 1.5px),
          linear-gradient(180deg, #dbeeff 0%, #edf6ff 42%, #f7fbff 100%);
        background-size: 220px 220px, 260px 260px, 180px 180px, cover;
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px 16px 24px;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.6rem, 3.2vw, 2.7rem);
        font-family: "Barlow Condensed", Impact, sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #f6fbff;
        text-shadow: 0 2px 14px rgba(0, 0, 0, 0.28);
      }

      .hero {
        position: relative;
        padding: 18px 18px 20px;
        margin-bottom: 14px;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid #8db5df;
        background:
          linear-gradient(125deg, rgba(255, 255, 255, 0.12) 0 22%, transparent 22% 100%),
          linear-gradient(180deg, #1a4f8d 0%, #103a68 70%, #0b2f55 100%);
        box-shadow: 0 14px 34px rgba(15, 52, 91, 0.32);
      }

      .hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(circle at 15% 24%, rgba(255, 255, 255, 0.22) 0 2px, transparent 2px),
          radial-gradient(circle at 76% 38%, rgba(255, 255, 255, 0.2) 0 2px, transparent 2px),
          radial-gradient(circle at 57% 70%, rgba(255, 255, 255, 0.16) 0 1.6px, transparent 1.6px);
        background-size: 200px 200px, 230px 230px, 180px 180px;
        pointer-events: none;
      }

      .hero::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 8px;
        background: repeating-linear-gradient(
          90deg,
          #c62230 0 56px,
          #f4f8ff 56px 112px
        );
        opacity: 0.95;
      }

      .kicker {
        margin: 0 0 6px;
        color: #d9ecff;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 700;
        font-size: 0.76rem;
      }

      .tagline {
        position: relative;
        z-index: 1;
        margin: 8px 0 0;
        color: #d9ebff;
        font-weight: 600;
        font-size: 0.92rem;
        max-width: 46ch;
      }

      .status {
        background: var(--card);
        border: 1px solid #a8c8ea;
        border-radius: 12px;
        padding: 12px 14px;
        margin-bottom: 12px;
        font-size: 0.96rem;
        font-weight: 600;
        color: #17395f;
        box-shadow: 0 10px 24px rgba(27, 77, 136, 0.15);
      }

      #map {
        height: min(75vh, 760px);
        border-radius: 12px;
        border: 1px solid #d9e2ec;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(16, 36, 58, 0.08);
      }

      .popup-list {
        margin: 8px 0 0;
        padding-left: 18px;
      }

      .popup-list li {
        margin: 2px 0;
      }

      .hometown-pin {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #1b6ca8;
        color: #fff;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
      }

      @media (max-width: 640px) {
        .hero {
          padding: 16px 14px 18px;
        }

        .tagline {
          font-size: 0.87rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="hero">
        <p class="kicker">Team USA Winter Map</p>
        <h1>2026 U.S. Olympian Hometowns</h1>
        <p class="tagline">American winter athletes, mapped by hometown across the U.S. and beyond.</p>
      </header>
      <div id="status" class="status">Loading data...</div>
      <div id="map" role="region" aria-label="Olympian hometown map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      const statusEl = document.getElementById("status");

      const map = L.map("map", {
        worldCopyJump: true
      }).setView([39.5, -98.35], 4);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      const clusters = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        maxClusterRadius: 50
      });
      map.addLayer(clusters);

      const GEOCODE_CACHE_KEY = "olympian-hometown-geocode-cache-v1";
      const geocodeCache = JSON.parse(localStorage.getItem(GEOCODE_CACHE_KEY) || "{}");

      function keyFor(city, stateCountry) {
        const normalize = (value) => value.trim().toLowerCase().replace(/\s+/g, " ");
        return `${normalize(city)}|${normalize(stateCountry)}`;
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function geocodeHometown(city, stateCountry) {
        const q = encodeURIComponent(`${city}, ${stateCountry}`);
        const url =
          `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=pjson&SingleLine=${q}&maxLocations=1`;

        const res = await fetch(url);
        if (!res.ok) return null;

        const data = await res.json();
        const top = data.candidates && data.candidates[0];
        if (!top || !top.location) return null;

        return {
          lat: top.location.y,
          lon: top.location.x
        };
      }

      async function loadCsvRows() {
        const text = await fetch("./olympians.csv").then((r) => r.text());

        const body = text.split(/\r?\n/).slice(1).join("\n");
        const parsed = Papa.parse(body, {
          header: true,
          skipEmptyLines: true
        });

        return parsed.data.filter((row) => row["First name"] && row["Last name"]);
      }

      async function loadPrecomputedCoords() {
        try {
          const data = await fetch("./hometown-coords.json").then((r) => r.json());
          return data.locations || {};
        } catch {
          return {};
        }
      }

      function hometownGroups(rows) {
        const groups = new Map();

        for (const row of rows) {
          const city = (row["Hometown City"] || "").trim();
          const stateCountry = (row["Hometown State/Country"] || "").trim();
          if (!city || !stateCountry) continue;

          const key = keyFor(city, stateCountry);
          if (!groups.has(key)) {
            groups.set(key, {
              city,
              stateCountry,
              athletes: []
            });
          }

          groups.get(key).athletes.push({
            name: `${(row["First name"] || "").trim()} ${(row["Last name"] || "").trim()}`.trim(),
            sport: (row["Sport"] || "").trim(),
            event: (row["Event"] || "").trim()
          });
        }

        return Array.from(groups.values());
      }

      function addMarker(group, lat, lon) {
        const hometown = `${group.city}, ${group.stateCountry}`;
        const sorted = [...group.athletes].sort((a, b) => a.name.localeCompare(b.name));

        const items = sorted
          .map((a) => {
            const searchUrl = `https://www.teamusa.com/search?q=${encodeURIComponent(a.name)}`;
            return `<li><a href="${searchUrl}" target="_blank" rel="noopener noreferrer"><strong>${a.name}</strong></a>${a.sport ? ` - ${a.sport}` : ""}</li>`;
          })
          .join("");

        const popup = `
          <div>
            <strong>${hometown}</strong><br/>
            ${group.athletes.length} Olympian${group.athletes.length === 1 ? "" : "s"}
            <ul class="popup-list">${items}</ul>
          </div>
        `;

        const count = group.athletes.length;
        const marker = L.marker([lat, lon], {
          icon: L.divIcon({
            className: "",
            html: `<div class="hometown-pin">${count}</div>`,
            iconSize: [34, 34],
            iconAnchor: [17, 17]
          })
        });
        marker.bindPopup(popup, { maxHeight: 260 });
        clusters.addLayer(marker);
      }

      async function render() {
        const [rows, precomputedCoords] = await Promise.all([
          loadCsvRows(),
          loadPrecomputedCoords()
        ]);
        const groups = hometownGroups(rows);

        let fromPrecomputed = 0;
        let geocodedNow = 0;
        let fromCache = 0;
        let failed = 0;

        statusEl.textContent = `Loaded ${rows.length} Olympians across ${groups.length} hometowns. Resolving coordinates...`;

        for (let i = 0; i < groups.length; i += 1) {
          const g = groups[i];
          const key = keyFor(g.city, g.stateCountry);

          let coords = precomputedCoords[key] || null;
          if (coords) {
            fromPrecomputed += 1;
          } else if (geocodeCache[key]) {
            coords = geocodeCache[key];
            fromCache += 1;
          } else {
            try {
              coords = await geocodeHometown(g.city, g.stateCountry);
            } catch {
              coords = null;
            }

            if (coords) {
              geocodeCache[key] = coords;
              geocodedNow += 1;
              localStorage.setItem(GEOCODE_CACHE_KEY, JSON.stringify(geocodeCache));
            } else {
              failed += 1;
            }

            // Keep requests polite.
            await sleep(120);
          }

          if (coords) addMarker(g, coords.lat, coords.lon);

          if ((i + 1) % 10 === 0 || i === groups.length - 1) {
            statusEl.textContent = `Processed ${i + 1}/${groups.length} hometowns. Mapped: ${fromPrecomputed + fromCache + geocodedNow}.`;
          }
        }

        const bounds = clusters.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));

        statusEl.textContent = `Done. ${rows.length} Olympians, ${fromPrecomputed + fromCache + geocodedNow} hometown pins.`;
      }

      render().catch((err) => {
        console.error(err);
        statusEl.textContent = "Could not load map data. Check console for details.";
      });
    </script>
  </body>
</html>
